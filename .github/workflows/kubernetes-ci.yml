---
# yamllint disable rule:truthy
name: kubernetes-gitops

on:
  pull_request:
    paths:
      - 'kubernetes/**'
      - '.github/workflows/kubernetes-ci.yml'
      - 'Makefile'
      - 'README.md'
      - 'docs/adr/**'
  push:
    branches: [main]
    paths:
      - 'kubernetes/**'
      - '.github/workflows/kubernetes-ci.yml'
      - 'Makefile'
      - 'README.md'
      - 'docs/adr/**'
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to promote (staging|prod)"
        required: true
        default: staging

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.5
      - name: Setup Python tooling
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade "importlib-metadata>=8.7.0" "packaging>=25.0"
          pip install ansible-core ansible-lint yamllint
          pip install --upgrade "importlib-metadata>=8.7.0"
      - name: Install kubeconform
        run: |
          KUBECONFORM_VERSION="0.6.7"
          curl -sSLo kubeconform.tar.gz "https://github.com/yannh/kubeconform/releases/download/v${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz"
          tar -xzf kubeconform.tar.gz kubeconform
          sudo install -m 0755 kubeconform /usr/local/bin/kubeconform
          rm -f kubeconform kubeconform.tar.gz
      - name: Install Flux CLI
        run: |
          FLUX_VERSION="2.7.3"
          curl -sSLo flux.tar.gz "https://github.com/fluxcd/flux2/releases/download/v${FLUX_VERSION}/flux_${FLUX_VERSION}_linux_amd64.tar.gz"
          tar -xzf flux.tar.gz flux
          sudo install -m 0755 flux /usr/local/bin/flux
          rm -f flux flux.tar.gz
      - name: Install security tooling
        run: |
          curl -sL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          KUBE_LINTER_VERSION="0.6.8"
          curl -sSLo kube-linter.tar.gz "https://github.com/stackrox/kube-linter/releases/download/v${KUBE_LINTER_VERSION}/kube-linter-linux.tar.gz"
          tar -xzf kube-linter.tar.gz kube-linter
          sudo install -m 0755 kube-linter /usr/local/bin/kube-linter
          rm -f kube-linter kube-linter.tar.gz
          TFSEC_VERSION="1.28.11"
          curl -sSLo tfsec.tar.gz "https://github.com/aquasecurity/tfsec/releases/download/v${TFSEC_VERSION}/tfsec_${TFSEC_VERSION}_linux_amd64.tar.gz"
          tar -xzf tfsec.tar.gz tfsec
          sudo install -m 0755 tfsec /usr/local/bin/tfsec
          rm -f tfsec tfsec.tar.gz
          pip install checkov
      - name: Install Flux dependencies
        run: flux install --export > /tmp/flux-components.yaml
      - name: Run make kubernetes/lint
        run: make kubernetes/lint
      - name: Flux diff (dry-run)
        run: |
          make kubernetes/flux-diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security:
    name: Security Scans
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.5
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install scanners
        run: |
          curl -sSfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin
          KUBE_LINTER_VERSION="0.6.8"
          curl -sSLo kube-linter.tar.gz "https://github.com/stackrox/kube-linter/releases/download/v${KUBE_LINTER_VERSION}/kube-linter-linux.tar.gz"
          tar -xzf kube-linter.tar.gz kube-linter
          sudo install -m 0755 kube-linter /usr/local/bin/kube-linter
          rm -f kube-linter kube-linter.tar.gz
          TFSEC_VERSION="1.28.11"
          curl -sSLo tfsec.tar.gz "https://github.com/aquasecurity/tfsec/releases/download/v${TFSEC_VERSION}/tfsec_${TFSEC_VERSION}_linux_amd64.tar.gz"
          tar -xzf tfsec.tar.gz tfsec
          sudo install -m 0755 tfsec /usr/local/bin/tfsec
          rm -f tfsec tfsec.tar.gz
          python -m pip install --upgrade pip
          pip install checkov
      - name: Run security checks
        run: make kubernetes/security

  review:
    name: Review Plan
    needs: [lint, security]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment:
      name: review
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.5
      - name: Terraform plan (all sites)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: make kubernetes/plan

  staging:
    name: Promote to staging
    needs: [lint, security]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment:
      name: staging
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.5
      - name: Terraform apply (staging)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: make kubernetes/apply

  prod:
    name: Promote to production
    needs: staging
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    runs-on: ubuntu-latest
    environment:
      name: prod
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.5
      - name: Terraform apply (production)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: make kubernetes/apply
