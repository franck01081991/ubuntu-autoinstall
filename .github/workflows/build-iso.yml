---
name: Validate Bare Metal Configurations

"on":
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - 'baremetal/**'
      - 'ansible/**'
      - 'scripts/install-sops.sh'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'
  pull_request:
    paths:
      - 'baremetal/**'
      - 'ansible/**'
      - 'scripts/install-sops.sh'
      - 'Makefile'
      - '.github/workflows/build-iso.yml'

jobs:
  validate:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - scope: hardware
            target: lenovo-m710q
          - scope: hardware
            target: dell-optiplex-3020m
          - scope: hardware
            target: lenovo-90dq004yfr
          - scope: hardware
            target: baieyu-p09
          - scope: host
            target: site-a-m710q1
          - scope: host
            target: site-b-m710q2
          - scope: host
            target: site-b-dell3020m
          - scope: host
            target: site-c-m710q3
          - scope: host
            target: site-d-baieyu-p09
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Python packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('ansible/requirements.txt') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip make age curl
          bash scripts/install-sops.sh /usr/local/bin
          python3 -m pip install --user -r ansible/requirements.txt
          $HOME/.local/bin/ansible-galaxy collection install -r ansible/collections/requirements.yml
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Render autoinstall for ${{ matrix.scope }} ${{ matrix.target }}
        env:
          PROFILE: ${{ matrix.scope == 'hardware' && matrix.target || '' }}
          HOST: ${{ matrix.scope == 'host' && matrix.target || '' }}
          TARGET: ${{ matrix.target }}
        run: |
          make baremetal/gen
          ls -al baremetal/autoinstall/generated/${TARGET}
          test -f baremetal/autoinstall/generated/${TARGET}/user-data
          test -f baremetal/autoinstall/generated/${TARGET}/meta-data
