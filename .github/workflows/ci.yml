---
name: CI

'on':
  push:
    branches: [main]
  pull_request: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            make \
            python3 \
            python3-yaml \
            python3-pip \
            git \
            ansible \
            xorriso \
            squashfs-tools \
            curl \
            ca-certificates \
            age \
            yamllint
          python3 -m pip install --user ansible-lint
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          GITLEAKS_VERSION=8.18.1
          GITLEAKS_TARBALL="gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          GITLEAKS_URL="https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/${GITLEAKS_TARBALL}"
          GITLEAKS_CHECKSUMS="https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_checksums.txt"
          GITLEAKS_TMPDIR="$(mktemp -d)"
          curl -sSL -o "${GITLEAKS_TMPDIR}/${GITLEAKS_TARBALL}" "$GITLEAKS_URL"
          curl -sSL -o "${GITLEAKS_TMPDIR}/checksums.txt" "$GITLEAKS_CHECKSUMS"
          grep "${GITLEAKS_TARBALL}" "${GITLEAKS_TMPDIR}/checksums.txt" > "${GITLEAKS_TMPDIR}/checksums.linux"
          (cd "${GITLEAKS_TMPDIR}" && sha256sum --check --status checksums.linux)
          tar -xzf "${GITLEAKS_TMPDIR}/${GITLEAKS_TARBALL}" -C "${GITLEAKS_TMPDIR}" gitleaks
          sudo install "${GITLEAKS_TMPDIR}/gitleaks" /usr/local/bin/gitleaks
          rm -rf "${GITLEAKS_TMPDIR}"

      - name: Install sops
        run: |
          SOPS_VERSION="3.8.1"
          SOPS_FILENAME="sops-v${SOPS_VERSION}.linux.amd64"
          SOPS_TARBALL="https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/${SOPS_FILENAME}"
          SOPS_CHECKSUMS="https://github.com/getsops/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.checksums.txt"
          curl -sSL -o "$SOPS_FILENAME" "$SOPS_TARBALL"
          curl -sSL -o sops.checksums "$SOPS_CHECKSUMS"
          grep "$SOPS_FILENAME" sops.checksums > sops.checksums.linux
          sha256sum --check --status sops.checksums.linux
          sudo install -m 0755 "$SOPS_FILENAME" /usr/local/bin/sops
          rm -f "$SOPS_FILENAME" sops.checksums sops.checksums.linux

      - name: Configure SOPS key material
        run: |
          age-keygen -o age.key
          echo "SOPS_AGE_KEY_FILE=$PWD/age.key" >> "$GITHUB_ENV"
          echo "SOPS_AGE_RECIPIENTS=$(age-keygen -y age.key)" >> "$GITHUB_ENV"

      - name: Onboard demo host
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          make new-host HOST=ci-demo DISK=/dev/sda
          cat <<'PLAINTEXT' > baremetal/inventory/host_vars/ci-demo/secrets.sops.yaml
          encrypt_disk_passphrase: ci-demo-passphrase
          PLAINTEXT
          sops --encrypt --in-place baremetal/inventory/host_vars/ci-demo/secrets.sops.yaml

      - name: Generate autoinstall seed
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          make gen HOST=ci-demo

      - name: Run gitleaks
        run: |
          gitleaks detect --no-git --source .

      - name: Run yamllint
        run: |
          yamllint .

      - name: Upload autoinstall artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-demo-autoinstall
          path: |
            baremetal/autoinstall/generated/ci-demo/user-data
            baremetal/autoinstall/generated/ci-demo/meta-data

      - name: Clean SOPS key
        if: always()
        run: |
          rm -f age.key
