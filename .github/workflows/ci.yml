name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y make python3 python3-yaml python3-pip git ansible xorriso squashfs-tools curl ca-certificates sops age yamllint
          python3 -m pip install --user ansible-lint
          export PATH="$HOME/.local/bin:$PATH"
          ansible-galaxy collection install community.sops
          GITLEAKS_VERSION=8.18.1
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz | tar -xz
          sudo install gitleaks /usr/local/bin/gitleaks

      - name: Configure SOPS key material
        run: |
          age-keygen -o age.key
          echo "SOPS_AGE_KEY_FILE=$PWD/age.key" >> "$GITHUB_ENV"
          echo "SOPS_AGE_RECIPIENTS=$(age-keygen -y age.key)" >> "$GITHUB_ENV"

      - name: Onboard demo host
        env:
          PATH: "$HOME/.local/bin:$PATH"
        run: |
          make new-host HOST=ci-demo DISK=/dev/sda
          cat <<'PLAINTEXT' > plain.yaml
          encrypt_disk_passphrase: ci-demo-passphrase
          PLAINTEXT
          sops --encrypt --input-type yaml --output-type yaml plain.yaml > baremetal/inventory/host_vars/ci-demo/secrets.sops.yaml
          rm plain.yaml

      - name: Generate autoinstall seed
        env:
          PATH: "$HOME/.local/bin:$PATH"
        run: |
          make gen HOST=ci-demo

      - name: Run gitleaks
        run: |
          gitleaks detect --no-git --source .

      - name: Run yamllint
        run: |
          yamllint .

      - name: Upload autoinstall artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-demo-autoinstall
          path: |
            baremetal/autoinstall/generated/ci-demo/user-data
            baremetal/autoinstall/generated/ci-demo/meta-data

      - name: Clean SOPS key
        if: always()
        run: |
          rm -f age.key
