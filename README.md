# ubuntu-autoinstall-git

Provision **Ubuntu Server 24.04 LTS** per host (ThinkCentre M710q, Dell 3020 Tiny, VPS) using **Autoinstall + cloud-init (NoCloud)**, all driven from **Git**.

## Quick start

1) Edit host vars in `inventory/host_vars/*.yml` (hostname, disk, net, ssh keys, password hash).
2) Generate per-host autoinstall files:
   ```bash
   make gen HOST=site-a-m710q1
   make gen HOST=site-b-m710q2
   make gen HOST=site-b-dell3020
   make gen HOST=site-c-m710q3
   make gen HOST=vps-sapinet
   ```
3) Build a tiny **seed ISO** (label **CIDATA**) for each host:
   ```bash
   make seed HOST=site-a-m710q1
   ```
   This produces `autoinstall/generated/<HOST>/seed-<HOST>.iso`.
4) Install Ubuntu:
   - Burn the official *Ubuntu 24.04 live server* ISO to a USB stick.
   - Plug **USB#1**: Ubuntu installer, **USB#2**: the *seed-<HOST>.iso* (or write seed ISO to a small USB).
   - Boot the host, at the GRUB menu press `e` and append to the Linux line:
     ```
     autoinstall
     ```
     (cloud-init NoCloud automatically picks up the `CIDATA` seed.)
   - Installation runs unattended.
5) (Optional) Build a **full ISO** with autoinstall baked-in and boot flags set:
   ```bash
   make fulliso HOST=site-a-m710q1 UBUNTU_ISO=/path/ubuntu-24.04-live-server-amd64.iso
   ```

## Variables
Edit `inventory/host_vars/<host>.yml`:
- `hostname`: machine hostname
- `disk_device`: e.g. `/dev/nvme0n1` or `/dev/sda`
- `netmode`: `dhcp` or `static`
- `nic`: interface name (e.g. `enp1s0`) if static
- `ip`, `cidr`, `gw`, `dns`: if static
- `ssh_authorized_keys`: list of pubkeys
- `password_hash`: YESCRYPT or SHA512 hash (e.g. generated by `mkpasswd -m yescrypt`)

## Notes
- Layout: GPT + EFI (512M) + /boot (1G) + LVM (root). Swap disabled.
- Tuning: enables BBR, rp_filter=2, disables redirects, enables irqbalance.
- Safe defaults: SSH server installed, password auth disabled (keys only).
- Everything rendered via Ansible Jinja2; no remote access needed.

## Make targets
- `make gen HOST=<name>`: render user-data/meta-data into `autoinstall/generated/<name>/`
- `make seed HOST=<name>`: build `seed-<name>.iso` (NoCloud `CIDATA`)
- `make fulliso HOST=<name> UBUNTU_ISO=<path>`: build a custom installer ISO with autoinstall baked in
- `make clean`: remove generated artifacts

## Security
- Replace the placeholder SSH key and **use your real keys**.
- Generate a strong password hash: `mkpasswd -m yescrypt` (from `whois`/`mkpasswd` package or `openssl passwd -6` for SHA512).



---

## GitHub Actions: build ISOs per host
A workflow is included at `.github/workflows/build-iso.yml`. It renders autoinstall per host and builds both seed and full installer ISOs, then uploads them as artifacts.

### Run manually
- Go to **Actions → Build Host ISOs → Run workflow**
- Optionally override `UBUNTU_ISO_URL`

Artifacts appear under the run, one archive per host.


## VPS provisioning with Ansible
Run the playbook after installing Ubuntu on the VPS:

```bash
ansible-playbook -i inventory/hosts.yml ansible/playbooks/vps_provision.yml -u ubuntu --become
```
Set variables in `group_vars` or via `-e` flags (e.g., `vps_domain`, `vps_acme_email`, `vps_external_dns_api_token`).
