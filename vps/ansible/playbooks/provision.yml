---
- name: Provision overlay networking and HA services on VPS
  hosts: vps-sapinet
  become: true
  gather_facts: true

  pre_tasks:
    - name: Check that encrypted VPS secrets file exists
      ansible.builtin.stat:
        path: "{{ vps_secrets_file }}"
      register: vps_secrets_stat
      delegate_to: localhost

    - name: Fail if encrypted VPS secrets file is missing
      ansible.builtin.assert:
        that:
          - vps_secrets_stat.stat.exists | default(false)
        fail_msg: >-
          Create and encrypt {{ vps_secrets_file }} (cp *.example && sops --encrypt --in-place)
      delegate_to: localhost

    - name: Load encrypted VPS secrets
      ansible.builtin.set_fact:
        overlay_network_secret_values: >-
          {{ lookup('pipe', 'sops -d --output-type json ' ~ vps_secrets_file) | from_json }}
      delegate_to: localhost
      delegate_facts: true
      no_log: true

    - name: Merge decrypted VPS secrets into host vars
      ansible.builtin.set_fact:
        "{{ item.key }}": "{{ item.value }}"
      loop: "{{ hostvars['localhost'].overlay_network_secret_values | dict2items }}"
      no_log: true

    - name: Assert required VPS secrets are defined
      ansible.builtin.assert:
        that:
          - overlay_network_wireguard_private_key is defined
          - overlay_network_wireguard_private_key | length > 0
          - overlay_network_keepalived_auth_passphrase is defined
          - overlay_network_keepalived_auth_passphrase | length > 0
        fail_msg: >-
          Populate vps/inventory/group_vars/vps/secrets.sops.yaml using SOPS (see README)

  roles:
    - role: overlay_network
