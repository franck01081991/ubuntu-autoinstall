---
# Shared tasks to render NoCloud autoinstall configurations
- name: Ensure autoinstall generated base directory exists
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated"
    state: directory
    mode: "0755"

- name: Resolve host target context
  ansible.builtin.set_fact:
    _host_name: "{{ target }}"
    _host_vars_dir: "{{ inventory_root }}/host_vars/{{ target }}"
    _host_vars_query:
      files:
        - main.yml
        - main.yaml
      paths:
        - "{{ inventory_root }}/host_vars/{{ target }}"
    _host_secrets_file: "{{ inventory_root }}/host_vars/{{ target }}/secrets.sops.yaml"

- name: Locate host variables file
  ansible.builtin.set_fact:
    _host_vars_file: "{{ lookup('first_found', _host_vars_query, errors='ignore') | default('', true) }}"

- name: Fail when host variables file is missing
  when: (_host_vars_file | length) == 0
  ansible.builtin.fail:
    msg: >-
      Missing inventory for host '{{ target }}'. Create
      baremetal/inventory/host_vars/{{ target }}/main.yml first (try `make new-host HOST={{ target }}`).

- name: Load host variables
  ansible.builtin.include_vars:
    file: "{{ _host_vars_file }}"

- name: Ensure host secrets file exists
  ansible.builtin.stat:
    path: "{{ _host_secrets_file }}"
  register: _host_secrets_stat

- name: Abort when host secrets file is missing
  when: not _host_secrets_stat.stat.exists
  ansible.builtin.fail:
    msg: >-
      Missing secrets for host '{{ target }}' (expected {{ _host_secrets_file }}).
      Populate it with sops before generating the autoinstall media.

- name: Load host secrets via sops
  community.sops.load_vars:
    file: "{{ _host_secrets_file }}"

- name: Determine disk encryption policy
  ansible.builtin.set_fact:
    encrypt_disk: "{{ encrypt_disk | default(true) }}"

- name: Validate disk encryption requirements
  when: encrypt_disk | bool
  ansible.builtin.assert:
    that:
      - encrypt_disk_passphrase is defined
      - encrypt_disk_passphrase | string | length > 0
    fail_msg: >-
      encrypt_disk_passphrase must be defined in {{ _host_secrets_file }} when disk encryption is enabled.

- name: Abort when disk encryption is disabled
  when: not (encrypt_disk | bool)
  ansible.builtin.fail:
    msg: >-
      Disk encryption is mandatory for bare metal installations. Set encrypt_disk to true in
      baremetal/inventory/host_vars/{{ target }}/main.yml.

- name: Set defaults for administrative account
  ansible.builtin.set_fact:
    admin_user_name: "{{ admin_user.name | default('admin') }}"
    admin_user_gecos: "{{ admin_user.gecos | default('ANSSI Admin User') }}"
    admin_user_shell: "{{ admin_user.shell | default('/bin/bash') }}"
    admin_user_groups: "{{ admin_user.groups | default(['sudo']) }}"

- name: Capture repository commit
  ansible.builtin.set_fact:
    repository_commit: "{{ lookup('pipe', 'git rev-parse HEAD') | default('unknown', true) | trim }}"

- name: Load ANSSI compliance marker helper script
  ansible.builtin.set_fact:
    anssi_marker_script: "{{ lookup('file', playbook_dir + '/../../../scripts/install_anssi_marker.sh') }}"

- name: Ensure output dir exists for target {{ target }}
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated/{{ target }}"
    state: directory
    mode: "0755"

- name: Render user-data (autoinstall)
  ansible.builtin.template:
    src: "{{ templates_root }}/user-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ target }}/user-data"
    mode: "0644"

- name: Render meta-data
  ansible.builtin.template:
    src: "{{ templates_root }}/meta-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ target }}/meta-data"
    mode: "0644"
