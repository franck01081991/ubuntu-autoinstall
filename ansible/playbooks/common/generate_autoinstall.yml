---
# Shared tasks to render NoCloud autoinstall configurations
- name: Ensure autoinstall generated base directory exists
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated"
    state: directory
    mode: "0755"

- name: Load hardware profile when rendering a PROFILE directly
  when: profile | length > 0
  ansible.builtin.include_vars:
    file: "{{ lookup('first_found', {
      'files': [profile + '.yml', profile + '.yaml'],
      'paths': [inventory_root + '/profiles/hardware']
    }) }}"

- name: Parse host variables to resolve the hardware profile
  when: profile | length == 0
  ansible.builtin.set_fact:
    host_raw_vars: "{{ lookup('file', primary_vars_file) | from_yaml }}"

- name: Load hardware profile referenced by the host
  when:
    - profile | length == 0
    - host_raw_vars.hardware_profile is defined
    - host_raw_vars.hardware_profile | length > 0
  ansible.builtin.include_vars:
    file: "{{ lookup('first_found', {
      'files': [host_raw_vars.hardware_profile + '.yml', host_raw_vars.hardware_profile + '.yaml'],
      'paths': [inventory_root + '/profiles/hardware']
    }) }}"

- name: Load host variables
  when: profile | length == 0
  ansible.builtin.include_vars:
    file: "{{ primary_vars_file }}"

- name: Check if host secrets file exists
  when: profile | length == 0
  ansible.builtin.stat:
    path: "{{ host_secrets_file }}"
  register: host_secrets_file_stat

- name: Load host secrets
  when:
    - profile | length == 0
    - host_secrets_file_stat.stat.exists
  ansible.builtin.include_vars:
    file: "{{ host_secrets_file }}"

- name: Load storage layout override when requested
  when:
    - storage_layout is defined
    - storage_layout | length > 0
  ansible.builtin.set_fact:
    _storage_layout_data: "{{ lookup('template', templates_root + '/storage/' + storage_layout + '.yml.j2') | from_yaml }}"

- name: Apply storage layout variables
  when: _storage_layout_data is defined
  ansible.builtin.set_fact:
    storage_config_override: "{{ _storage_layout_data.storage_config_override }}"
    storage_swap_size: "{{ storage_swap_size | default(_storage_layout_data.storage_swap_size | default(0), true) }}"
    storage_additional_late_commands: "{{ (storage_additional_late_commands | default([])) + (_storage_layout_data.additional_late_commands | default([])) }}"

- name: Ensure output dir exists for target {{ config_name }}
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated/{{ config_name }}"
    state: directory
    mode: "0755"

- name: Render user-data (autoinstall)
  ansible.builtin.template:
    src: "{{ templates_root }}/user-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ config_name }}/user-data"
    mode: "0644"

- name: Render meta-data
  ansible.builtin.template:
    src: "{{ templates_root }}/meta-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ config_name }}/meta-data"
    mode: "0644"
