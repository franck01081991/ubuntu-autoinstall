---
# Shared tasks to render NoCloud autoinstall configurations
- name: Ensure autoinstall generated base directory exists
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated"
    state: directory
    mode: "0755"

- name: Load hardware profile when rendering a PROFILE directly
  when: profile | length > 0
  ansible.builtin.include_vars:
    file: "{{ inventory_root }}/profiles/hardware/{{ profile }}.yml"

- name: Parse host variables to resolve the hardware profile
  when: profile | length == 0
  ansible.builtin.set_fact:
    host_raw_vars: "{{ lookup('file', primary_vars_file) | from_yaml }}"

- name: Load hardware profile referenced by the host
  when:
    - profile | length == 0
    - host_raw_vars.hardware_profile is defined
    - host_raw_vars.hardware_profile | length > 0
  ansible.builtin.include_vars:
    file: "{{ inventory_root }}/profiles/hardware/{{ host_raw_vars.hardware_profile }}.yml"

- name: Load host variables
  when: profile | length == 0
  ansible.builtin.include_vars:
    file: "{{ primary_vars_file }}"

- name: Ensure output dir exists for target {{ config_name }}
  ansible.builtin.file:
    path: "{{ autoinstall_dir }}/generated/{{ config_name }}"
    state: directory
    mode: "0755"

- name: Render user-data (autoinstall)
  ansible.builtin.template:
    src: "{{ templates_root }}/user-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ config_name }}/user-data"
    mode: "0644"

- name: Render meta-data
  ansible.builtin.template:
    src: "{{ templates_root }}/meta-data.j2"
    dest: "{{ autoinstall_dir }}/generated/{{ config_name }}/meta-data"
    mode: "0644"
