---
- name: Render autoinstall NoCloud for a host or hardware profile (baremetal)
  hosts: localhost
  gather_facts: false
  vars:
    autoinstall_dir: "{{ playbook_dir }}/../../autoinstall"
    templates_root: "{{ autoinstall_dir }}/templates"
    inventory_repo_root: "{{ playbook_dir }}/../../inventory"
    inventory_overlay_root: "{{ lookup('env','AUTOINSTALL_LOCAL_DIR') | default(playbook_dir + '/../../inventory-local', true) }}"
    inventory_profile_paths: >-
      {{ (
          [inventory_overlay_root + '/profiles/hardware']
          if inventory_overlay_root | length > 0
          else []
        )
        + [inventory_repo_root + '/profiles/hardware']
      }}
    inventory_host_paths: >-
      {{ (
          [inventory_overlay_root + '/host_vars']
          if inventory_overlay_root | length > 0
          else []
        )
        + [inventory_repo_root + '/host_vars']
      }}
    inventory_host_search_paths: >-
      {{ (inventory_host_paths | map('regex_replace', '$', '/' + config_name)) | list }}
    target: "{{ lookup('env','HOST') | default(host, true) }}"
    profile: "{{ lookup('env','PROFILE') | default('', true) }}"
    config_name: "{{ profile if profile else target }}"
    primary_vars_file: >-
      {{ lookup(
        'first_found',
        {
          'files': (
            [config_name + '.yml', config_name + '.yaml']
            if profile
            else ['main.yml', 'main.yaml']
          ),
          'paths': (
            inventory_profile_paths
            if profile
            else inventory_host_search_paths
          ),
        }
      ) }}
  tasks:
    - name: Include shared autoinstall rendering tasks
      ansible.builtin.import_tasks: "{{ playbook_dir }}/../../../ansible/playbooks/common/generate_autoinstall.yml"
