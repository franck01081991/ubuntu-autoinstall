#cloud-config
autoinstall:
  version: 1
  locale: {{ locale | default('fr_FR.UTF-8') }}
  keyboard:
    layout: {{ keyboard_layout | default('fr') }}
    variant: {{ keyboard_variant | default('oss') }}
  identity:
    hostname: {{ hostname }}
    username: {{ username | default('admin') }}
    password: "{{ password_hash }}"
  ssh:
    install-server: true
    authorized-keys:
{% for key in ssh_authorized_keys %}
      - "{{ key }}"
{% endfor %}
    allow-pw: false
  apt:
    geoip: false
    primary:
      - arches: [amd64]
        uri: {{ apt_primary_uri | default('http://archive.ubuntu.com/ubuntu') }}
        suites: ['noble','noble-updates','noble-security']
  packages:
    - jq
    - ca-certificates
    - curl
    - htop
    - ethtool
    - git
    - irqbalance
{% for pkg in extra_packages | default([]) %}
    - {{ pkg }}
{% endfor %}
  storage:
    swap:
      size: 0
    config:
      - id: disk0
        type: disk
        match:
          path: "{{ disk_device }}"
        wipe: superblock-recursive
        ptable: gpt
        grub_device: true
{% for extra_disk in additional_disk_devices | default([]) %}
      - id: disk{{ loop.index }}
        type: disk
        match:
          path: "{{ extra_disk }}"
        preserve: true
{% endfor %}
      - type: partition
        id: efi
        device: disk0
        size: 512M
        flag: boot
      - type: partition
        id: boot
        device: disk0
        size: 1G
      - type: partition
        id: pv1
        device: disk0
        size: -1
        flag: lvm
      - type: format
        id: fmt-efi
        volume: efi
        fstype: fat32
      - type: format
        id: fmt-boot
        volume: boot
        fstype: ext4
      - type: lvm_volgroup
        id: vg0
        devices: [ pv1 ]
      - type: lvm_partition
        id: lv_root
        volgroup: vg0
        size: -1
      - type: format
        id: fmt-root
        volume: lv_root
        fstype: ext4
      - type: mount
        id: mnt-efi
        path: /boot/efi
        device: fmt-efi
      - type: mount
        id: mnt-boot
        path: /boot
        device: fmt-boot
      - type: mount
        id: mnt-root
        path: /
        device: fmt-root
{% if netmode == 'static' %}
  network:
    version: 2
    ethernets:
      {{ nic }}:
        dhcp4: false
        addresses: [ "{{ ip }}/{{ cidr }}" ]
        gateway4: "{{ gw }}"
        nameservers:
          addresses: {{ dns }}
{% else %}
  network:
    version: 2
    ethernets:
      {{ nic | default('') }}: {}
    renderer: networkd
{% endif %}
  user-data:
    disable_root: true
  late-commands:
    - curtin in-target -- bash -lc 'cat >/etc/sysctl.d/99-tuning.conf <<EOF
net.ipv4.ip_forward=1
net.ipv4.tcp_congestion_control=bbr
net.ipv4.conf.all.rp_filter=2
net.ipv4.conf.default.accept_redirects=0
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.default.send_redirects=0
net.ipv4.conf.all.send_redirects=0
EOF'
    - curtin in-target -- sysctl --system
    - curtin in-target -- systemctl enable irqbalance
{% if enable_powertop_autotune | default(false) %}
    - curtin in-target -- bash -lc 'cat >/etc/systemd/system/powertop-autotune.service <<"EOF"\n[Unit]\nDescription=Powertop auto-tuning on boot\nAfter=multi-user.target\n\n[Service]\nType=oneshot\nExecStart=/usr/sbin/powertop --auto-tune\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\nEOF'
    - curtin in-target -- systemctl daemon-reload
    - curtin in-target -- systemctl enable powertop-autotune.service
    - curtin in-target -- systemctl start powertop-autotune.service
{% endif %}
{% if enable_thermald | default(false) %}
    - curtin in-target -- systemctl enable thermald
    - curtin in-target -- systemctl start thermald
{% endif %}
{% if enable_zram_generator | default(false) %}
{%   set zram_cfg = (zram_generator_config | default({})).get('swap', {}) %}
    - curtin in-target -- bash -lc 'cat >/etc/systemd/zram-generator.conf <<"EOF"\n[zram0]\n{% if zram_cfg['zram-fraction'] is defined %}zram-fraction = {{ zram_cfg['zram-fraction'] }}\n{% endif %}{% if zram_cfg['max-zram-size'] is defined %}max-zram-size = {{ zram_cfg['max-zram-size'] }}M\n{% endif %}{% if zram_cfg['compression-algorithm'] is defined %}compression-algorithm = {{ zram_cfg['compression-algorithm'] }}\n{% endif %}{% if zram_cfg['swap-priority'] is defined %}swap-priority = {{ zram_cfg['swap-priority'] }}\n{% endif %}EOF'
    - curtin in-target -- systemctl enable systemd-zram-setup@zram0.service
    - curtin in-target -- systemctl start systemd-zram-setup@zram0.service
{% endif %}
