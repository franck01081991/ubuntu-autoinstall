#cloud-config
autoinstall:
  version: 1
  identity:
    hostname: {{ hostvars.hostname | default(inventory_hostname) }}
    username: {{ hostvars.admin_user | default('admin') }}
    password: {{ hostvars.admin_password_hashed | default('!') }}  # déconseillé; préfère auth par clé
  ssh:
    install-server: true
    allow-pw: false
{% if hostvars.ssh_authorized_keys is defined %}
    authorized-keys:
{% for k in hostvars.ssh_authorized_keys %}
      - {{ k }}
{% endfor %}
{% endif %}

  {% include "partials/storage_luks.j2" %}

  late-commands:
    # SSH durci (pas de root, pas de password)
    - curtin in-target -- sed -i 's/^#\?PasswordAuthentication .*/PasswordAuthentication no/' /etc/ssh/sshd_config
    - curtin in-target -- sed -i 's/^#\?PermitRootLogin .*/PermitRootLogin no/' /etc/ssh/sshd_config
    - curtin in-target -- systemctl restart ssh

    # sudo journalisé
    - curtin in-target -- bash -c 'echo "Defaults logfile=/var/log/sudo.log" >/etc/sudoers.d/99-sudo-log && chmod 440 /etc/sudoers.d/99-sudo-log'

    # services inutiles (serveur)
    - curtin in-target -- systemctl disable --now avahi-daemon || true
    - curtin in-target -- systemctl disable --now cups || true
    - curtin in-target -- systemctl disable --now bluetooth || true

    # trace de conformité
    - curtin in-target -- bash -c 'echo "anssi_profile=enabled" > /etc/anssi-profile && date -Iseconds >> /etc/anssi-profile'

    # archive des logs d'install
    - curtin in-target -- bash -c 'tar czf /root/autoinstall-logs.tgz /var/log/installer /var/log/cloud-init* 2>/dev/null || true'
