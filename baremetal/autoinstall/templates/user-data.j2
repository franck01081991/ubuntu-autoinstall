#cloud-config
autoinstall:
  version: 1
  locale: {{ locale | default('fr_FR.UTF-8') }}
  keyboard:
    layout: {{ keyboard_layout | default('fr') }}
    variant: {{ keyboard_variant | default('oss') }}
  identity:
    hostname: {{ hostname }}
    username: {{ admin_user_name }}
    password: "!"
  ssh:
    install-server: true
    allow-pw: false
{% if ssh_authorized_keys | default([]) %}
    authorized-keys:
{%   for key in ssh_authorized_keys %}
      - "{{ key }}"
{%   endfor %}
{% endif %}
  storage:
    config:
      - id: disk0
        type: disk
        match:
{% if install_disk | default('') %}
          path: {{ install_disk }}
{% else %}
          size: largest
{% endif %}
        wipe: superblock-recursive
        ptable: gpt
        grub_device: true
      - id: part-efi
        type: partition
        device: disk0
        size: 512M
        flag: boot
      - id: part-luks
        type: partition
        device: disk0
        size: -1
      - id: luks-system
        type: dm_crypt
        volume: part-luks
        dm_name: cryptosystem
        key: "{{ encrypt_disk_passphrase }}"
        cipher: aes-xts-plain64
        keysize: 512
        pbkdf:
          type: argon2id
          time: 4
          memory: 1048576
          parallel: 2
      - id: vg-system
        type: lvm_volgroup
        name: vg_system
        devices:
          - luks-system
      - id: lv-root
        type: lvm_partition
        name: lv_root
        volgroup: vg-system
        size: -1
      - id: fmt-efi
        type: format
        volume: part-efi
        fstype: fat32
      - id: fmt-root
        type: format
        volume: lv-root
        fstype: ext4
      - id: mount-efi
        type: mount
        path: /boot/efi
        device: fmt-efi
      - id: mount-root
        type: mount
        path: /
        device: fmt-root
  network:
    version: 2
    renderer: networkd
    ethernets:
      {{ network_interface | default('eth0') }}:
{% if network | default({}) and network.get('method') == 'static' %}
        dhcp4: false
        addresses:
          - {{ network.address }}
        gateway4: {{ network.gateway }}
        nameservers:
          addresses: {{ network.nameservers | to_json }}
{% else %}
        dhcp4: true
{% endif %}
  user-data:
    disable_root: true
    package_update: true
    package_upgrade: true
    users:
      - name: {{ admin_user_name }}
        gecos: {{ admin_user_gecos | to_json }}
        groups: {{ admin_user_groups | to_json }}
        shell: {{ admin_user_shell }}
        lock-passwd: true
        sudo: "ALL=(ALL) NOPASSWD:ALL"
{% if ssh_authorized_keys | default([]) %}
        ssh_authorized_keys:
{%   for key in ssh_authorized_keys %}
          - "{{ key }}"
{%   endfor %}
{% endif %}
    packages:
      - git
      - ansible
      - python3-apt
      - curl
      - ca-certificates
      - auditd
      - needrestart
      - unattended-upgrades
    write_files:
      - path: /root/install_anssi_marker.sh
        permissions: '0750'
        owner: root:root
        content: |
{{ anssi_marker_script | indent(10) }}
      - path: /etc/sudoers.d/zz-logfile
        permissions: '0440'
        owner: root:root
        content: |
          Defaults logfile="/var/log/sudo.log"
          Defaults log_host,log_year
      - path: /etc/systemd/system/collect-autoinstall-logs.service
        owner: root:root
        permissions: '0644'
        content: |
          [Unit]
          Description=Archive autoinstall logs after installation
          ConditionPathExists=!/root/autoinstall-logs.tgz
          After=multi-user.target

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/env bash -c 'set -euo pipefail; tar -czf /root/autoinstall-logs.tgz /var/log/installer /var/log/cloud-init*'

          [Install]
          WantedBy=multi-user.target
    runcmd:
      - [systemctl, daemon-reload]
      - [systemctl, enable, --now, collect-autoinstall-logs.service]
  late-commands:
    - curtin in-target -- chmod 0644 /etc/sudoers.d/zz-logfile
    - curtin in-target -- bash -c 'set -euo pipefail; mkdir -p /var/log/journal'
    - curtin in-target -- bash -c 'set -euo pipefail; systemctl disable --now avahi-daemon.service || true'
    - curtin in-target -- bash -c 'set -euo pipefail; systemctl disable --now cups.service || true'
    - curtin in-target -- bash -c 'set -euo pipefail; systemctl disable --now bluetooth.service || true'
    - curtin in-target -- bash -c 'set -euo pipefail; sed -i "s/^#\?PermitRootLogin.*/PermitRootLogin no/" /etc/ssh/sshd_config'
    - curtin in-target -- bash -c 'set -euo pipefail; sed -i "s/^#\?PasswordAuthentication.*/PasswordAuthentication no/" /etc/ssh/sshd_config'
    - curtin in-target -- bash -c 'set -euo pipefail; sed -i "s/^#\?KbdInteractiveAuthentication.*/KbdInteractiveAuthentication no/" /etc/ssh/sshd_config'
    - curtin in-target -- systemctl restart ssh
    - curtin in-target -- bash -c '/root/install_anssi_marker.sh "{{ repository_commit }}"'
    - curtin in-target -- bash -c 'set -euo pipefail; systemctl mask ctrl-alt-del.target'
    - curtin in-target -- bash -c 'set -euo pipefail; touch /etc/cloud/cloud-init.disabled'
{% if log_upload_url | default('') %}
    - curtin in-target -- bash -c 'set -euo pipefail; if [ -f /root/autoinstall-logs.tgz ]; then curl -X PUT -T /root/autoinstall-logs.tgz {{ log_upload_url }}; fi'
{% endif %}
