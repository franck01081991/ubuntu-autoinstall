# baremetal/autoinstall/templates/nocloud/user-data
#cloud-config
autoinstall:
  version: 1

  # Pas d’écrans interactifs
  interactive-sections: []

  locale: fr_FR.UTF-8
  keyboard:
    layout: fr
    variant: ""

  # Réseau: tout en DHCP v4/v6
  network:
    network:
      version: 2
      ethernets:
        all:
          match:
            name: "*"
          dhcp4: true
          dhcp6: true

  # Source d'installation (serveur minimal)
  source:
    id: ubuntu-server-minimal

  # Stockage: LVM + chiffrement LUKS (passphrase à remplacer)
  storage:
    layout:
      name: lvm
      sizing-policy: all
      password: "Dedemichel1991/"

  # Utilisateur principal (hash SHA-512 requis)
  identity:
    hostname: ci-demo
    realname: "Ubuntu User"
    username: ubuntu
    password: "Dedemichel1991/"

  # SSH: serveur installé + clés, pas de mot de passe
  ssh:
    install-server: true
    authorized-keys:
      - "ssh-ed25519 AAAA...ta_cle_publique..."
    allow-pw: false

  # Mises à jour et paquet(s) utiles
  updates: security
  packages:
    - qemu-guest-agent

  # Cloud-init à exécuter DANS le système cible (post-install)
  user-data:
    timezone: Europe/Paris
    write_files:
      - path: /etc/ssh/sshd_config.d/10-hardening.conf
        content: |
          PasswordAuthentication no
          KbdInteractiveAuthentication no
          ChallengeResponseAuthentication no
        permissions: '0644'
    runcmd:
      - systemctl enable --now qemu-guest-agent || true
      - systemctl restart ssh || true

  # Comportement final
  shutdown: reboot
